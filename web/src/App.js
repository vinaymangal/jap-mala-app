// web/src/App.js - Web version of Jap Mala App
import React, { useState, useEffect } from 'react';
import './App.css';

const COLORS = {
  primary: '#FF6B35',
  secondary: '#FFE5DB',
  accent: '#FFB3B3',
  background: '#FFF5F5',
  white: '#FFFFFF',
  text: '#333333',
  lightText: '#666666',
  success: '#4CAF50',
  error: '#F44336',
  gold: '#FFD700',
  krishnaBlue: '#1976D2',
  shivaAsh: '#757575',
  lotus: '#E91E63',
};

const DEITIES = [
  { id: 'ram', name: '‡§∞‡§æ‡§Æ', mantra: '‡§ú‡§Ø ‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§Æ', color: COLORS.primary },
  { id: 'krishna', name: '‡§ï‡•É‡§∑‡•ç‡§£', mantra: '‡§π‡§∞‡•á ‡§ï‡•É‡§∑‡•ç‡§£', color: COLORS.krishnaBlue },
  { id: 'radha', name: '‡§∞‡§æ‡§ß‡§æ', mantra: '‡§∞‡§æ‡§ß‡•á ‡§∞‡§æ‡§ß‡•á', color: COLORS.lotus },
  { id: 'shiva', name: '‡§∂‡§ø‡§µ', mantra: '‡•ê ‡§®‡§Æ‡§É ‡§∂‡§ø‡§µ‡§æ‡§Ø', color: COLORS.shivaAsh },
  { id: 'hanuman', name: '‡§π‡§®‡•Å‡§Æ‡§æ‡§®', mantra: '‡§ú‡§Ø ‡§π‡§®‡•Å‡§Æ‡§æ‡§®', color: COLORS.primary },
  { id: 'ganesh', name: '‡§ó‡§£‡•á‡§∂', mantra: '‡•ê ‡§ó‡§Ç ‡§ó‡§£‡§™‡§§‡§Ø‡•á ‡§®‡§Æ‡§É', color: COLORS.gold },
];

const MANTRAS = [
  {
    id: 'gayatri',
    name: '‡§ó‡§æ‡§Ø‡§§‡•ç‡§∞‡•Ä ‡§Æ‡§Ç‡§§‡•ç‡§∞',
    text: '‡•ê ‡§≠‡•Ç‡§∞‡•ç ‡§≠‡•Å‡§µ‡§É ‡§∏‡•ç‡§µ‡§É\n‡§§‡§§‡•ç ‡§∏‡§µ‡§ø‡§§‡•Å‡§∞‡•ç ‡§µ‡§∞‡•á‡§£‡•ç‡§Ø‡§Ç\n‡§≠‡§∞‡•ç‡§ó‡•ã ‡§¶‡•á‡§µ‡§∏‡•ç‡§Ø ‡§ß‡•Ä‡§Æ‡§π‡§ø\n‡§ß‡§ø‡§Ø‡•ã ‡§Ø‡•ã ‡§®‡§É ‡§™‡•ç‡§∞‡§ö‡•ã‡§¶‡§Ø‡§æ‡§§‡•ç',
    meaning: 'We meditate on the glory of the Creator',
    count: 108,
  },
  {
    id: 'mahamrityunjay',
    name: '‡§Æ‡§π‡§æ‡§Æ‡•É‡§§‡•ç‡§Ø‡•Å‡§Ç‡§ú‡§Ø ‡§Æ‡§Ç‡§§‡•ç‡§∞',
    text: '‡•ê ‡§§‡•ç‡§∞‡•ç‡§Ø‡§Æ‡•ç‡§¨‡§ï‡§Ç ‡§Ø‡§ú‡§æ‡§Æ‡§π‡•á\n‡§∏‡•Å‡§ó‡§®‡•ç‡§ß‡§ø‡§Ç ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø‡§µ‡§∞‡•ç‡§ß‡§®‡§Æ‡•ç\n‡§â‡§∞‡•ç‡§µ‡§æ‡§∞‡•Å‡§ï‡§Æ‡§ø‡§µ ‡§¨‡§®‡•ç‡§ß‡§®‡§æ‡§®‡•ç\n‡§Æ‡•É‡§§‡•ç‡§Ø‡•ã‡§∞‡•ç‡§Æ‡•Å‡§ï‡•ç‡§∑‡•Ä‡§Ø ‡§Æ‡§æ‡§Æ‡•É‡§§‡§æ‡§§‡•ç',
    meaning: 'We worship the three-eyed Lord Shiva',
    count: 108,
  },
];

function App() {
  const [currentTab, setCurrentTab] = useState('home');
  const [currentDeity, setCurrentDeity] = useState(DEITIES[0]);
  const [count, setCount] = useState(0);
  const [malaCount, setMalaCount] = useState(0);
  const [totalCount, setTotalCount] = useState(0);
  const [totalMala, setTotalMala] = useState(0);
  const [history, setHistory] = useState([]);
  const [showDeityModal, setShowDeityModal] = useState(false);
  const [vibrationEnabled, setVibrationEnabled] = useState(true);
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [streak, setStreak] = useState(0);
  
  // Meditation timer states
  const [isTimerActive, setIsTimerActive] = useState(false);
  const [timerMinutes, setTimerMinutes] = useState(10);
  const [timerSeconds, setTimerSeconds] = useState(0);
  const [selectedDuration, setSelectedDuration] = useState(10);

  // Load data from localStorage
  useEffect(() => {
    const savedData = localStorage.getItem('japMalaData');
    if (savedData) {
      const data = JSON.parse(savedData);
      setTotalCount(data.totalCount || 0);
      setTotalMala(data.totalMala || 0);
      setHistory(data.history || []);
      setStreak(data.streak || 0);
      if (data.currentDeity) {
        const deity = DEITIES.find(d => d.id === data.currentDeity);
        if (deity) setCurrentDeity(deity);
      }
    }
  }, []);

  // Save data to localStorage
  useEffect(() => {
    const dataToSave = {
      currentDeity: currentDeity.id,
      totalCount,
      totalMala,
      history,
      streak,
      lastActiveDate: new Date().toDateString(),
    };
    localStorage.setItem('japMalaData', JSON.stringify(dataToSave));
  }, [currentDeity, totalCount, totalMala, history, streak]);

  // Meditation timer effect
  useEffect(() => {
    let interval = null;
    
    if (isTimerActive && (timerMinutes > 0 || timerSeconds > 0)) {
      interval = setInterval(() => {
        if (timerSeconds === 0) {
          if (timerMinutes === 0) {
            setIsTimerActive(false);
            completeMeditation();
          } else {
            setTimerMinutes(timerMinutes - 1);
            setTimerSeconds(59);
          }
        } else {
          setTimerSeconds(timerSeconds - 1);
        }
      }, 1000);
    }
    
    return () => clearInterval(interval);
  }, [isTimerActive, timerMinutes, timerSeconds]);

  const handleChant = () => {
    const newCount = count + 1;
    setCount(newCount);
    setTotalCount(totalCount + 1);

    // Vibration for web (if supported)
    if (vibrationEnabled && navigator.vibrate) {
      navigator.vibrate(50);
    }

    // Play sound
    if (soundEnabled && newCount % 10 === 0) {
      playBellSound();
    }

    if (newCount >= 108) {
      completeMala();
    }
  };

  const completeMala = () => {
    setCount(0);
    const newMalaCount = malaCount + 1;
    setMalaCount(newMalaCount);
    setTotalMala(totalMala + 1);
    
    const newEntry = {
      id: Date.now().toString(),
      deity: currentDeity.name,
      malaCount: newMalaCount,
      date: new Date().toLocaleDateString('hi-IN'),
      time: new Date().toLocaleTimeString('hi-IN'),
    };
    setHistory([newEntry, ...history]);
    
    playBellSound();
    showNotification('‡§Æ‡§æ‡§≤‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£!', `‡§Ü‡§™‡§®‡•á ${currentDeity.name} ‡§®‡§æ‡§Æ ‡§ï‡•Ä ${newMalaCount} ‡§Æ‡§æ‡§≤‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡•Ä‡•§`);
  };

  const playBellSound = () => {
    const audio = new Audio('/sounds/bell.mp3');
    audio.play().catch(e => console.log('Audio play failed:', e));
  };

  const showNotification = (title, body) => {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(title, { body, icon: '/icon-192.png' });
    }
  };

  const startMeditation = () => {
    setTimerMinutes(selectedDuration);
    setTimerSeconds(0);
    setIsTimerActive(true);
  };

  const completeMeditation = () => {
    playBellSound();
    showNotification('‡§ß‡•ç‡§Ø‡§æ‡§® ‡§™‡•Ç‡§∞‡•ç‡§£', `‡§¨‡§ß‡§æ‡§à ‡§π‡•ã! ‡§Ü‡§™‡§®‡•á ${selectedDuration} ‡§Æ‡§ø‡§®‡§ü ‡§ï‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡§ø‡§Ø‡§æ‡•§`);
  };

  const share = async () => {
    const shareData = {
      title: '‡§ú‡§™ ‡§Æ‡§æ‡§≤‡§æ',
      text: `üôè ‡§Æ‡•à‡§Ç‡§®‡•á ‡§Ü‡§ú ${currentDeity.name} ‡§®‡§æ‡§Æ ‡§ï‡•Ä ${malaCount} ‡§Æ‡§æ‡§≤‡§æ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡•Ä! ‡§ï‡•Å‡§≤ ‡§ú‡§™: ${totalCount} üïâÔ∏è`,
      url: window.location.href,
    };

    try {
      if (navigator.share) {
        await navigator.share(shareData);
      } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(shareData.text);
        alert('Copied to clipboard!');
      }
    } catch (err) {
      console.log('Error sharing:', err);
    }
  };

  // Request notification permission
  useEffect(() => {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  }, []);

  const renderHome = () => (
    <div className="home-container">
      <div className="stats-row">
        <div className="stat-card">
          <div className="stat-value">{streak}</div>
          <div className="stat-label">‡§¶‡§ø‡§® ‡§ï‡•Ä streak</div>
        </div>
        <div className="stat-card">
          <div className="stat-value">{totalCount}</div>
          <div className="stat-label">‡§ï‡•Å‡§≤ ‡§ú‡§™</div>
        </div>
        <div className="stat-card">
          <div className="stat-value">{totalMala}</div>
          <div className="stat-label">‡§ï‡•Å‡§≤ ‡§Æ‡§æ‡§≤‡§æ</div>
        </div>
      </div>

      <div className="deity-selector" onClick={() => setShowDeityModal(true)}>
        <h2 className="deity-name">{currentDeity.name}</h2>
        <p className="deity-mantra">{currentDeity.mantra}</p>
      </div>

      <div 
        className="chant-button"
        style={{ background: `linear-gradient(135deg, ${currentDeity.color}, ${COLORS.primary})` }}
        onClick={handleChant}
      >
        <div className="chant-count">{count}</div>
        <div className="progress-bar">
          <div 
            className="progress-fill" 
            style={{ width: `${(count / 108) * 100}%` }}
          />
        </div>
      </div>

      <div className="session-info">
        <h3>‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡§§‡•ç‡§∞</h3>
        <div className="session-stats">
          <div>
            <span className="session-value">{malaCount}</span>
            <span className="session-label">‡§Æ‡§æ‡§≤‡§æ</span>
          </div>
          <div>
            <span className="session-value">{malaCount * 108 + count}</span>
            <span className="session-label">‡§ú‡§™</span>
          </div>
        </div>
      </div>

      <div className="action-buttons">
        <button className="action-btn" onClick={() => setCount(0)}>‡§∞‡•Ä‡§∏‡•á‡§ü</button>
        <button className="action-btn" onClick={share}>‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç</button>
      </div>

      {/* Deity Modal */}
      {showDeityModal && (
        <div className="modal-overlay" onClick={() => setShowDeityModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h2>‡§¶‡•á‡§µ‡§§‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç</h2>
            <div className="deity-list">
              {DEITIES.map(deity => (
                <div 
                  key={deity.id}
                  className={`deity-item ${currentDeity.id === deity.id ? 'selected' : ''}`}
                  style={{ borderColor: deity.color }}
                  onClick={() => {
                    setCurrentDeity(deity);
                    setShowDeityModal(false);
                  }}
                >
                  <h3 style={{ color: deity.color }}>{deity.name}</h3>
                  <p>{deity.mantra}</p>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}
    </div>
  );

  const renderMantras = () => (
    <div className="mantras-container">
      <h1 className="page-title">‡§™‡§µ‡§ø‡§§‡•ç‡§∞ ‡§Æ‡§Ç‡§§‡•ç‡§∞</h1>
      <div className="mantras-grid">
        {MANTRAS.map(mantra => (
          <div key={mantra.id} className="mantra-card">
            <h2>{mantra.name}</h2>
            <p className="mantra-text">{mantra.text}</p>
            <p className="mantra-meaning">{mantra.meaning}</p>
            <button className="mantra-btn">‡§ú‡§™ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç ({mantra.count} ‡§¨‡§æ‡§∞)</button>
          </div>
        ))}
      </div>
    </div>
  );

  const renderMeditation = () => (
    <div className="meditation-container">
      <h1 className="page-title">‡§ß‡•ç‡§Ø‡§æ‡§® ‡§ü‡§æ‡§á‡§Æ‡§∞</h1>
      
      {!isTimerActive ? (
        <>
          <p className="meditation-prompt">‡§ß‡•ç‡§Ø‡§æ‡§® ‡§ï‡•Ä ‡§Ö‡§µ‡§ß‡§ø ‡§ö‡•Å‡§®‡•á‡§Ç:</p>
          <div className="duration-grid">
            {[5, 10, 15, 20, 30, 45, 60].map(duration => (
              <button
                key={duration}
                className={`duration-btn ${selectedDuration === duration ? 'selected' : ''}`}
                onClick={() => setSelectedDuration(duration)}
              >
                {duration} ‡§Æ‡§ø‡§®‡§ü
              </button>
            ))}
          </div>
          <button className="start-meditation-btn" onClick={startMeditation}>
            ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç
          </button>
        </>
      ) : (
        <>
          <div className="timer-display">
            {String(timerMinutes).padStart(2, '0')}:{String(timerSeconds).padStart(2, '0')}
          </div>
          <p className="breathing-guide">‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§≤‡•á‡§Ç... ‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§õ‡•ã‡§°‡§º‡•á‡§Ç...</p>
          <button className="stop-meditation-btn" onClick={() => setIsTimerActive(false)}>
            ‡§∞‡•ã‡§ï‡•á‡§Ç
          </button>
        </>
      )}
      
      <div className="meditation-tips">
        <h3>‡§ß‡•ç‡§Ø‡§æ‡§® ‡§∏‡•Å‡§ù‡§æ‡§µ:</h3>
        <ul>
          <li>‡§Ü‡§∞‡§æ‡§Æ‡§¶‡§æ‡§Ø‡§ï ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Æ‡•á‡§Ç ‡§¨‡•à‡§†‡•á‡§Ç</li>
          <li>‡§Ü‡§Å‡§ñ‡•á‡§Ç ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§ß‡•Ä‡§Æ‡•á ‡§∏‡•á ‡§ñ‡•Å‡§≤‡•Ä ‡§∞‡§ñ‡•á‡§Ç</li>
          <li>‡§∏‡§æ‡§Ç‡§∏ ‡§™‡§∞ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</li>
          <li>‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§Ü‡§®‡•á ‡§¶‡•á‡§Ç ‡§î‡§∞ ‡§ú‡§æ‡§®‡•á ‡§¶‡•á‡§Ç</li>
        </ul>
      </div>
    </div>
  );

  const renderSettings = () => (
    <div className="settings-container">
      <h1 className="page-title">‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</h1>
      
      <div className="settings-section">
        <h2>‡§ß‡•ç‡§µ‡§®‡§ø ‡§î‡§∞ ‡§ï‡§Ç‡§™‡§®</h2>
        <div className="setting-row">
          <span>‡§ï‡§Ç‡§™‡§®</span>
          <label className="switch">
            <input 
              type="checkbox" 
              checked={vibrationEnabled}
              onChange={(e) => setVibrationEnabled(e.target.checked)}
            />
            <span className="slider"></span>
          </label>
        </div>
        <div className="setting-row">
          <span>‡§ß‡•ç‡§µ‡§®‡§ø</span>
          <label className="switch">
            <input 
              type="checkbox" 
              checked={soundEnabled}
              onChange={(e) => setSoundEnabled(e.target.checked)}
            />
            <span className="slider"></span>
          </label>
        </div>
      </div>
      
      <div className="about-section">
        <h2>‡§ê‡§™ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç</h2>
        <p>‡§ú‡§™ ‡§Æ‡§æ‡§≤‡§æ v1.0.0</p>
        <p>‡§°‡§ø‡§ú‡§ø‡§ü‡§≤ ‡§Æ‡§æ‡§≤‡§æ ‡§ï‡§æ‡§â‡§Ç‡§ü‡§∞</p>
        <p>üïâÔ∏è ‡§∏‡§∞‡•ç‡§µ‡•á ‡§≠‡§µ‡§®‡•ç‡§§‡•Å ‡§∏‡•Å‡§ñ‡§ø‡§®‡§É üïâÔ∏è</p>
      </div>
    </div>
  );

  return (
    <div className="app">
      <header className="app-header">
        <h1>üìø ‡§ú‡§™ ‡§Æ‡§æ‡§≤‡§æ</h1>
      </header>

      <main className="app-main">
        {currentTab === 'home' && renderHome()}
        {currentTab === 'mantras' && renderMantras()}
        {currentTab === 'meditation' && renderMeditation()}
        {currentTab === 'settings' && renderSettings()}
      </main>

      <nav className="app-nav">
        <button 
          className={`nav-btn ${currentTab === 'home' ? 'active' : ''}`}
          onClick={() => setCurrentTab('home')}
        >
          <span className="nav-icon">üìø</span>
          <span className="nav-label">‡§ú‡§™</span>
        </button>
        <button 
          className={`nav-btn ${currentTab === 'mantras' ? 'active' : ''}`}
          onClick={() => setCurrentTab('mantras')}
        >
          <span className="nav-icon">üïâÔ∏è</span>
          <span className="nav-label">‡§Æ‡§Ç‡§§‡•ç‡§∞</span>
        </button>
        <button 
          className={`nav-btn ${currentTab === 'meditation' ? 'active' : ''}`}
          onClick={() => setCurrentTab('meditation')}
        >
          <span className="nav-icon">üßò</span>
          <span className="nav-label">‡§ß‡•ç‡§Ø‡§æ‡§®</span>
        </button>
        <button 
          className={`nav-btn ${currentTab === 'settings' ? 'active' : ''}`}
          onClick={() => setCurrentTab('settings')}
        >
          <span className="nav-icon">‚öôÔ∏è</span>
          <span className="nav-label">‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó‡•ç‡§∏</span>
        </button>
      </nav>
    </div>
  );
}

export default App;